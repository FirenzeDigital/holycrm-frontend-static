<!-- admin/module-builder-pb.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PocketBase Module Builder</title>
    <link rel="stylesheet" href="../assets/css/styles.css">
    <style>
        .builder-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            height: calc(100vh - 100px);
        }
        
        .sidebar {
            background: #f8f9fa;
            padding: 20px;
            border-right: 1px solid #dee2e6;
            overflow-y: auto;
        }
        
        .main-content {
            padding: 20px;
            overflow-y: auto;
        }
        
        .collection-list {
            margin-bottom: 20px;
        }
        
        .collection-item {
            padding: 10px;
            margin: 5px 0;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .collection-item:hover {
            background: #e9ecef;
            border-color: #adb5bd;
        }
        
        .collection-item.active {
            background: #007bff;
            color: white;
            border-color: #0056b3;
        }
        
        .field-config {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .field-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .field-options {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        
        .config-section {
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
        }
        
        .tab-container {
            margin-bottom: 20px;
        }
        
        .tab-buttons {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 2px solid #dee2e6;
        }
        
        .tab-button {
            padding: 10px 20px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 500;
        }
        
        .tab-button.active {
            border-bottom-color: #007bff;
            color: #007bff;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .preview-area {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 6px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .checkbox-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì¶ PocketBase Module Builder</h1>
        <p class="text-muted">Configure modules by selecting collections and customizing views</p>
        
        <div class="builder-container">
            <!-- Sidebar: Collections List -->
            <div class="sidebar">
                <div class="form-group">
                    <h4>Paste PocketBase Schema</h4>
                    <p class="text-muted">Copy your schema from PocketBase admin ‚Üí Settings ‚Üí Import collections</p>
                    <textarea id="pb-schema-input" class="form-control" 
                              rows="15" 
                              placeholder='Paste your pb_schema.json array here...'
                              style="font-family: monospace; font-size: 12px;"></textarea>
                </div>
                
                <div class="btn-group">
                    <button id="parse-schema-btn" class="btn btn-primary">Parse Schema</button>
                    <button id="load-example-btn" class="btn btn-outline-secondary">Example</button>
                </div>
                
                <hr>
                
                <div class="collection-list">
                    <h4>Collections</h4>
                    <div id="collections-list">
                        <p class="text-muted">Parse schema to see collections</p>
                    </div>
                </div>

                <div class="existing-configs" style="margin-top: 20px;">
                    <h4>Existing Configurations</h4>
                    <div id="modules-list">
                        <p class="text-muted">No configurations loaded yet</p>
                    </div>
                </div>
            </div>
            
            <!-- Main Content: Configuration -->
            <div class="main-content">
                <div id="config-area" style="display: none;">
                    <h3 id="selected-collection-name">No Collection Selected</h3>
                    
                    <div class="tab-container">
                        <div class="tab-buttons">
                            <button class="tab-button active" data-tab="general">General</button>
                            <button class="tab-button" data-tab="list-view">List View</button>
                            <button class="tab-button" data-tab="form-view">Form View</button>
                            <button class="tab-button" data-tab="permissions">Permissions</button>
                            <button class="tab-button" data-tab="preview">Preview</button>
                        </div>
                        
                        <!-- General Settings -->
                        <div class="tab-content active" id="tab-general">
                            <div class="config-section">
                                <h4>Module Information</h4>
                                <div class="form-group">
                                    <label for="module-key">Module Key (unique identifier)</label>
                                    <input type="text" id="module-key" class="form-control">
                                </div>
                                
                                <div class="form-group">
                                    <label for="module-name">Display Name</label>
                                    <input type="text" id="module-name" class="form-control">
                                </div>
                                
                                <div class="form-group">
                                    <label for="module-icon">Icon</label>
                                    <select id="module-icon" class="form-control">
                                        <option value="people">üë• People</option>
                                        <option value="calendar">üìÖ Calendar</option>
                                        <option value="dollar">üíµ Finance</option>
                                        <option value="location">üìç Location</option>
                                        <option value="group">üë™ Group</option>
                                        <option value="activity">üìä Activity</option>
                                        <option value="settings">‚öôÔ∏è Settings</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>Module Type</label>
                                    <select id="module-type" class="form-control">
                                        <option value="crud">CRUD (Create, Read, Update, Delete)</option>
                                        <option value="readonly">Read Only</option>
                                        <option value="calendar">Calendar View</option>
                                        <option value="kanban">Kanban Board</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- List View Configuration -->
                        <div class="tab-content" id="tab-list-view">
                            <div class="config-section">
                                <div class="section-header">
                                    <h4>üìã List View Configuration</h4>
                                    <div class="section-actions">
                                        <button type="button" id="auto-configure-btn" class="btn btn-outline btn-sm">
                                            Auto-configure
                                        </button>
                                        <button type="button" id="add-column-btn" class="btn btn-outline btn-sm">
                                            + Add Custom Column
                                        </button>
                                        <button type="button" id="sort-columns-btn" class="btn btn-outline btn-sm">
                                            Sort A-Z
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label>Default Sort Field</label>
                                    <select id="default-sort" class="form-control">
                                        <option value="created">Created Date (Newest First)</option>
                                        <option value="-created">Created Date (Oldest First)</option>
                                        <option value="updated">Updated Date</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>Items Per Page</label>
                                    <input type="number" id="items-per-page" class="form-control" value="25" min="5" max="100">
                                </div>
                                
                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" id="enable-search" checked> Enable Search
                                    </label>
                                </div>
                                
                                <div class="columns-configuration">
                                    <h5>Columns Configuration</h5>
                                    <p class="text-muted">Drag to reorder, click to configure each column</p>
                                    
                                    <div id="columns-list-container" class="columns-list">
                                        <!-- Columns will be rendered here -->
                                        <div class="empty-state">
                                            <p>No columns configured yet. Click "Auto-configure" to start.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Form View Configuration -->
                        <div class="tab-content" id="tab-form-view">
                            <div class="config-section">
                                <div class="section-header">
                                    <h4>üìù Form Configuration</h4>
                                    <div class="section-actions">
                                        <button type="button" class="btn btn-outline btn-sm" onclick="moduleBuilder.autoConfigure()">
                                            Auto-configure Form
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label>Form Layout</label>
                                    <select id="form-layout" class="form-control">
                                        <option value="single">Single Column</option>
                                        <option value="two-column">Two Columns</option>
                                        <option value="tabs">Tabbed Interface</option>
                                        <option value="wizard">Wizard (Multi-step)</option>
                                    </select>
                                </div>
                                
                                <div class="fields-configuration">
                                    <h5>Form Fields</h5>
                                    <p class="text-muted">Configure each field that appears in the create/edit form</p>
                                    
                                    <div id="fields-list-container" class="fields-list">
                                        <!-- Fields will be rendered here -->
                                        <div class="empty-state">
                                            <p>No form fields configured yet.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="tab-content" id="tab-relations">
                            <div class="config-section">
                                <div class="section-header">
                                    <h4>üîó Relations Configuration</h4>
                                    <div class="section-actions">
                                        <button type="button" id="scan-relations-btn" class="btn btn-outline btn-sm">
                                            Scan for Relations
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="relations-container">
                                    <p class="text-muted">Relations will be displayed here after scanning.</p>
                                </div>
                                
                                <div class="relations-help">
                                    <h5>About Relations</h5>
                                    <p>Relations allow you to connect records between collections. For example:</p>
                                    <ul>
                                        <li><strong>Members ‚Üí Church</strong>: Each member belongs to one church</li>
                                        <li><strong>Events ‚Üí Ministry</strong>: Each event is organized by a ministry</li>
                                        <li><strong>Users ‚Üí Roles</strong>: Users can have multiple roles</li>
                                    </ul>
                                    <p>Relations are automatically handled in forms (dropdown selection) and tables (display related data).</p>
                                </div>
                            </div>
                        </div>

                        <div class="tab-content" id="tab-ui-preview">
                            <div class="config-section">
                                <div class="section-header">
                                    <h4>üëÅÔ∏è UI Preview</h4>
                                    <div class="section-actions">
                                        <button type="button" class="btn btn-outline btn-sm" onclick="moduleBuilder.previewUI()">
                                            Refresh Preview
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="ui-preview-container">
                                    <p class="text-muted">Preview will appear here after generating configuration.</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Permissions -->
                        <div class="tab-content" id="tab-permissions">
                            <div class="config-section">
                                <h4>Default Permissions by Role</h4>
                                <p class="text-muted">Set default CRUD permissions for each role</p>
                                
                                <div class="permissions-table">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Role</th>
                                                <th>Create</th>
                                                <th>Read</th>
                                                <th>Update</th>
                                                <th>Delete</th>
                                            </tr>
                                        </thead>
                                        <tbody id="permissions-body">
                                            <!-- Dynamically populated -->
                                        </tbody>
                                    </table>
                                </div>
                                
                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" id="allow-overrides">
                                        Allow church-specific permission overrides
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Preview -->
                        <div class="tab-content" id="tab-preview">
                            <div class="config-section">
                                <h4>Configuration Preview</h4>
                                <div class="preview-area" id="json-preview"></div>
                                
                                <div class="btn-group">
                                    <button id="generate-module-btn" class="btn btn-primary">Generate Configuration</button>
                                    <button id="preview-ui-btn" class="btn btn-outline">Preview UI</button>
                                    <button id="copy-json-btn" class="btn btn-outline">Copy JSON</button>
                                    <button id="download-json-btn" class="btn btn-success">Download Config</button>
                                    <button id="reset-config-btn" class="btn btn-danger">Reset</button>
                                </div>
                                
                                <div style="margin-top: 30px; display: none;" id="code-preview-section">
                                    <h5>Generated Module Code</h5>
                                    <div class="preview-area" id="code-preview"></div>
                                    <button id="copy-code-btn" class="btn btn-outline-primary">Copy Code</button>
                                    <button id="save-module-btn" class="btn btn-success">Save Module</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="welcome-message">
                    <div style="text-align: center; padding: 60px 20px;">
                        <h3>Welcome to Module Builder</h3>
                        <p class="text-muted">Select a collection from the sidebar to start configuring a module</p>
                        <p>Or connect to your PocketBase instance to see available collections</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Templates -->
    <template id="field-config-template">
        <div class="field-config" data-field-name="">
            <div class="field-header">
                <h5 class="field-name">Field Name</h5>
                <label class="checkbox-item">
                    <input type="checkbox" class="field-include"> Include
                </label>
            </div>
            
            <div class="field-options" style="display: none;">
                <div class="form-group">
                    <label>Display Label</label>
                    <input type="text" class="form-control field-label" placeholder="Enter display label">
                </div>
                
                <div class="form-group">
                    <label>Field Type</label>
                    <select class="form-control field-type">
                        <option value="text">Text</option>
                        <option value="email">Email</option>
                        <option value="number">Number</option>
                        <option value="date">Date</option>
                        <option value="select">Select</option>
                        <option value="boolean">Boolean</option>
                        <option value="textarea">Text Area</option>
                        <option value="file">File</option>
                    </select>
                </div>
                
                <div class="form-group select-options-container" style="display: none;">
                    <label>Select Options (one per line)</label>
                    <textarea class="form-control select-options" rows="3" placeholder="Option 1&#10;Option 2&#10;Option 3"></textarea>
                </div>
                
                <div class="form-group">
                    <label>Placeholder</label>
                    <input type="text" class="form-control field-placeholder" placeholder="Optional placeholder">
                </div>
                
                <div class="checkbox-group">
                    <label class="checkbox-item">
                        <input type="checkbox" class="field-required"> Required
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" class="field-sortable"> Sortable
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" class="field-filterable"> Filterable
                    </label>
                </div>
                
                <div class="form-group">
                    <label>Column Width</label>
                    <select class="form-control field-width">
                        <option value="auto">Auto</option>
                        <option value="100px">100px</option>
                        <option value="150px">150px</option>
                        <option value="200px">200px</option>
                        <option value="250px">250px</option>
                        <option value="300px">300px</option>
                    </select>
                </div>
            </div>
        </div>
    </template>

    <!-- <script src="../assets/js/pocketbase.umd.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/pocketbase@0.26.6/dist/pocketbase.umd.js"></script>
    <script src="module-builder-ui.js"></script>
    <!-- JavaScript to handle select options visibility -->
    <script>
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('field-type')) {
            const fieldConfig = e.target.closest('.field-config');
            const optionsContainer = fieldConfig.querySelector('.select-options-container');
            if (optionsContainer) {
                optionsContainer.style.display = e.target.value === 'select' ? 'block' : 'none';
            }
        }
    });
    </script>
</body>
</html>
