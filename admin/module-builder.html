<!-- admin/module-builder.html -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Enhanced Module Builder - HolyCRM</title>
  <link rel="stylesheet" href="../assets/css/styles.css">
  <style>
    .builder-container { max-width: 1400px; margin: 0 auto; padding: 20px; }
    .builder-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
    .schema-panel, .config-panel { background: white; border-radius: 8px; padding: 20px; }
    .field-list { max-height: 400px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 4px; padding: 10px; }
    .field-item { 
      padding: 12px; 
      border-bottom: 1px solid #f0f0f0; 
      margin: 5px 0; 
      cursor: move;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .field-item:last-child { border-bottom: none; }
    .field-badge {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 3px;
      background: #e3f2fd;
      color: #1976d2;
    }
    .field-badge.relation { background: #e8f5e8; color: #2e7d32; }
    .field-badge.select { background: #fff3e0; color: #f57c00; }
    .preview-panel { grid-column: 1 / -1; }
    .code-output { 
      background: #1e1e1e; 
      color: #d4d4d4; 
      padding: 20px; 
      border-radius: 8px; 
      font-family: 'Monaco', monospace;
      max-height: 500px;
      overflow-y: auto;
    }
    .drop-zone { 
      border: 2px dashed #ccc; 
      padding: 40px; 
      text-align: center; 
      margin: 20px 0;
      border-radius: 8px;
      background: #fafafa;
    }
    .drop-zone.drag-over { border-color: #007bff; background: #e3f2fd; }
    .field-checkbox { margin: 10px 0; padding: 8px; background: #f9f9f9; border-radius: 4px; }
    .config-section { margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 6px; }
    .module-info { background: #e8f5e8; padding: 15px; border-radius: 6px; margin-bottom: 20px; }
    .error-message { color: #dc3545; background: #f8d7da; padding: 10px; border-radius: 4px; margin: 10px 0; }
    .success-message { color: #28a745; background: #d4edda; padding: 10px; border-radius: 4px; margin: 10px 0; }
    .generator-tabs { display: flex; gap: 10px; margin: 20px 0; }
    .generator-tab { padding: 10px 20px; background: #f0f0f0; border: none; border-radius: 4px; cursor: pointer; }
    .generator-tab.active { background: #007bff; color: white; }
    .generator-panel { display: none; }
    .generator-panel.active { display: block; }
  </style>
</head>
<body>
  <div class="builder-container">
    <h1>üöÄ Enhanced Module Builder</h1>
    <p>Choose your generator method:</p>
    
    <div class="generator-tabs">
      <button class="generator-tab active" data-tab="pb-generator">PocketBase JSON Generator</button>
      <button class="generator-tab" data-tab="openapi-generator">OpenAPI Generator</button>
    </div>
    
    <!-- PocketBase JSON Generator Panel -->
    <div id="pb-generator" class="generator-panel active">
      <div class="module-info">
        <h3>üì¶ PocketBase JSON Generator:</h3>
        <ul>
          <li>1. Paste PocketBase collection JSON below</li>
          <li>2. Configure fields for table and form</li>
          <li>3. Generate module</li>
        </ul>
      </div>
      
      <div class="drop-zone" id="json-drop-zone">
        <h3>üìÅ Import PocketBase Collection</h3>
        <p>Drag & drop a PocketBase collection JSON file here</p>
        <p>or <button id="paste-json" class="btn-primary">Paste JSON directly</button></p>
        <p><small>Get JSON from PocketBase: Collections ‚Üí Click collection ‚Üí "Copy raw JSON" button</small></p>
      </div>
      
      <div id="pb-parsing-error" class="error-message" style="display:none"></div>
      <div id="pb-parsing-success" class="success-message" style="display:none"></div>
      
      <div class="builder-grid">
        <div class="schema-panel">
          <h3>üìã Collection Schema Analysis</h3>
          <div id="pb-schema-info"></div>
          <h4>Available Fields:</h4>
          <div class="field-list" id="pb-field-list">
            <div class="muted">No schema loaded yet...</div>
          </div>
        </div>
        
        <div class="config-panel">
          <h3>‚öôÔ∏è Module Configuration</h3>
          
          <div class="config-section">
            <h4>Basic Info</h4>
            <div class="field">
              <label>Module Name (technical)</label>
              <input type="text" id="pb-module-name" placeholder="e.g., members">
              <small>Used for function names and permissions</small>
            </div>
            
            <div class="field">
              <label>Display Label</label>
              <input type="text" id="pb-module-label" placeholder="e.g., Miembros">
            </div>
            
            <div class="field">
              <label>Icon</label>
              <select id="pb-module-icon">
                <option value="üë•">üë• People</option>
                <option value="üí∞">üí∞ Money</option>
                <option value="üìÖ">üìÖ Calendar</option>
                <option value="üìç">üìç Location</option>
                <option value="üë™">üë™ Group</option>
                <option value="üìä">üìä Chart</option>
                <option value="üé≠">üé≠ Ministry</option>
                <option value="üõ†Ô∏è">üõ†Ô∏è Service</option>
                <option value="üìù">üìù Notes</option>
              </select>
            </div>
          </div>
          
          <div class="config-section">
            <h4>Table Columns</h4>
            <p><small>Choose which fields to show in the table</small></p>
            <div id="pb-table-columns-config"></div>
          </div>
          
          <div class="config-section">
            <h4>Form Fields</h4>
            <p><small>Choose which fields to include in the create/edit form</small></p>
            <div id="pb-form-fields-config"></div>
          </div>
        </div>
      </div>
      
      <div class="preview-panel">
        <h3>üëÅÔ∏è Preview & Generated Code</h3>
        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
          <button id="pb-generate-code" class="btn-primary">Generate Module</button>
          <button id="pb-download-module" class="btn-secondary" disabled>Download JS File</button>
        </div>
        
        <div id="pb-generator-status"></div>
        
        <div class="code-output">
          <pre id="pb-generated-code">// Generated code will appear here</pre>
        </div>
      </div>
    </div>
    
    <!-- OpenAPI Generator Panel -->
    <div id="openapi-generator" class="generator-panel">
      <div class="module-info">
        <h3>üì¶ OpenAPI Generator:</h3>
        <ul>
          <li>1. Paste your full OpenAPI spec JSON</li>
          <li>2. Select collection and configure</li>
          <li>3. Relation fields are automatically detected from OpenAPI</li>
          <li>4. Generate module with proper relation handling</li>
        </ul>
      </div>
      
      <div class="field">
        <label>OpenAPI Spec JSON</label>
        <textarea id="openapi-spec" rows="15" placeholder="Paste your full OpenAPI spec here..."></textarea>
        <small>Use the full OpenAPI JSON, not just a collection</small>
      </div>
      
      <button id="load-openapi" class="btn-primary">Parse OpenAPI Spec</button>
      
      <div id="openapi-parsing-error" class="error-message" style="display:none"></div>
      <div id="openapi-parsing-success" class="success-message" style="display:none"></div>
      
      <div class="builder-grid" id="openapi-builder" style="display: none;">
        <div class="schema-panel">
          <h3>üìã Collection Selection</h3>
          <div class="field">
            <label>Select Collection</label>
            <select id="openapi-collection">
              <option value="">-- Select a collection --</option>
            </select>
          </div>
          
          <div id="openapi-schema-info"></div>
          
          <h4>Available Fields:</h4>
          <div class="field-list" id="openapi-field-list">
            <div class="muted">Select a collection first...</div>
          </div>
        </div>
        
        <div class="config-panel">
          <h3>‚öôÔ∏è Module Configuration</h3>
          
          <div class="config-section">
            <h4>Basic Info</h4>
            <div class="field">
              <label>Module Name (technical)</label>
              <input type="text" id="openapi-module-name" placeholder="e.g., members">
              <small>Used for function names and permissions</small>
            </div>
            
            <div class="field">
              <label>Display Label</label>
              <input type="text" id="openapi-module-label" placeholder="e.g., Miembros">
            </div>
            
            <div class="field">
              <label>Icon</label>
              <input type="text" id="openapi-icon" value="üìã" placeholder="e.g., üë•, üìç">
            </div>
          </div>
          
          <div class="config-section">
            <h4>Detected Relations</h4>
            <div id="openapi-relations-info"></div>
          </div>
        </div>
      </div>
      
      <div class="preview-panel" id="openapi-preview" style="display: none;">
        <h3>üëÅÔ∏è Preview & Generated Code</h3>
        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
          <button id="openapi-generate-code" class="btn-primary">Generate Module</button>
          <button id="openapi-download-module" class="btn-secondary" disabled>Download JS File</button>
        </div>
        
        <div id="openapi-generator-status"></div>
        
        <div class="code-output">
          <pre id="openapi-generated-code">// Generated code will appear here</pre>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { EnhancedModuleGenerator } from '../assets/js/core/EnhancedModuleGenerator.js';
    import { OpenAPIModuleGenerator } from '../assets/js/core/OpenAPIModuleGenerator.js';
    
    // Tab switching
    document.querySelectorAll('.generator-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        // Update tabs
        document.querySelectorAll('.generator-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        // Update panels
        document.querySelectorAll('.generator-panel').forEach(p => p.classList.remove('active'));
        document.getElementById(tab.dataset.tab).classList.add('active');
      });
    });
    
    // ========== PocketBase Generator ==========
    const pbGenerator = new EnhancedModuleGenerator();
    let pbCurrentSchema = null;
    let pbGeneratedCode = null;
    
    // DOM Elements for PB
    const pbDropZone = document.getElementById('json-drop-zone');
    const pbPasteBtn = document.getElementById('paste-json');
    const pbGenerateBtn = document.getElementById('pb-generate-code');
    const pbDownloadBtn = document.getElementById('pb-download-module');
    const pbSchemaInfo = document.getElementById('pb-schema-info');
    const pbFieldList = document.getElementById('pb-field-list');
    const pbTableConfig = document.getElementById('pb-table-columns-config');
    const pbFormConfig = document.getElementById('pb-form-fields-config');
    const pbGeneratedCodeEl = document.getElementById('pb-generated-code');
    const pbGeneratorStatus = document.getElementById('pb-generator-status');
    const pbParsingError = document.getElementById('pb-parsing-error');
    const pbParsingSuccess = document.getElementById('pb-parsing-success');
    
    // PB JSON Drop Zone
    pbDropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      pbDropZone.classList.add('drag-over');
    });
    
    pbDropZone.addEventListener('dragleave', () => {
      pbDropZone.classList.remove('drag-over');
    });
    
    pbDropZone.addEventListener('drop', async (e) => {
      e.preventDefault();
      pbDropZone.classList.remove('drag-over');
      
      const file = e.dataTransfer.files[0];
      if (file && file.type === 'application/json') {
        try {
          const text = await file.text();
          pbLoadSchema(JSON.parse(text));
        } catch (error) {
          pbShowError('Error reading file: ' + error.message);
        }
      } else {
        pbShowError('Please drop a JSON file');
      }
    });
    
    // Paste JSON button
    pbPasteBtn.addEventListener('click', async () => {
      try {
        const json = prompt('Paste PocketBase collection JSON:');
        if (json) {
          const parsed = JSON.parse(json);
          pbLoadSchema(parsed);
        }
      } catch (error) {
        pbShowError('Invalid JSON: ' + error.message);
      }
    });
    
    function pbLoadSchema(pbJson) {
      try {
        pbParsingError.style.display = 'none';
        pbParsingSuccess.style.display = 'none';
        
        console.log('Parsing PB schema:', pbJson.name);
        pbCurrentSchema = pbGenerator.parseCollectionSchema(pbJson);
        
        // Auto-populate module name and label
        document.getElementById('pb-module-name').value = pbCurrentSchema.collectionName;
        document.getElementById('pb-module-label').value = pbGenerator.formatLabel(pbCurrentSchema.collectionName);
        
        pbRenderSchemaInfo();
        pbRenderConfigUI();
        
        pbParsingSuccess.textContent = `‚úÖ Successfully parsed "${pbCurrentSchema.collectionName}" collection with ${pbCurrentSchema.fields.length} fields`;
        pbParsingSuccess.style.display = 'block';
        
        pbShowStatus(`Ready to generate "${pbCurrentSchema.collectionName}" module`, 'info');
        
      } catch (error) {
        console.error('Error parsing schema:', error);
        pbShowError('Failed to parse schema: ' + error.message);
        pbCurrentSchema = null;
      }
    }
    
    function pbRenderSchemaInfo() {
      if (!pbCurrentSchema) return;
      
      const relationCount = pbCurrentSchema.fields.filter(f => f.type === 'relation').length;
      const selectCount = pbCurrentSchema.fields.filter(f => f.type === 'select').length;
      
      pbSchemaInfo.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
          <div>
            <strong>Collection:</strong><br>
            <span style="font-size: 18px; color: #1976d2;">${pbCurrentSchema.collectionName}</span>
          </div>
          <div>
            <strong>Type:</strong><br>
            ${pbCurrentSchema.isChurchSpecific ? 'üèõÔ∏è Church-specific' : 'üåç Global'}
          </div>
          <div>
            <strong>Fields:</strong><br>
            ${pbCurrentSchema.fields.length} total<br>
            ${relationCount} relations, ${selectCount} selects
          </div>
          <div>
            <strong>Church Field:</strong><br>
            ${pbCurrentSchema.hasChurchField ? '‚úÖ Auto-handled' : '‚ùå Not present'}
          </div>
        </div>
      `;
      
      // Render field list
      pbFieldList.innerHTML = pbCurrentSchema.fields.map(field => {
        const badgeClass = field.type === 'relation' ? 'relation' : field.type === 'select' ? 'select' : '';
        const badgeText = field.type === 'relation' ? 'Relation ‚Üí ' + (field.relationCollection || 'unknown') : 
                         field.type === 'select' ? 'Select' : field.type;
        
        return `
          <div class="field-item">
            <div>
              <strong>${field.label}</strong><br>
              <small>${field.name} ‚Ä¢ ${field.required ? 'Required' : 'Optional'}</small>
            </div>
            <span class="field-badge ${badgeClass}">${badgeText}</span>
          </div>
        `;
      }).join('');
    }
    
    function pbRenderConfigUI() {
      if (!pbCurrentSchema) return;
      
      // Generate table columns config
      pbTableConfig.innerHTML = pbCurrentSchema.fields
        .filter(field => field.type !== 'relation')
        .map(field => `
          <div class="field-checkbox">
            <label>
              <input type="checkbox" 
                     data-field="${field.name}" 
                     data-type="${field.type}"
                     ${['name', 'title', 'first_name', 'email', 'date'].includes(field.name) ? 'checked' : ''}>
              ${field.label}
              <small>(${field.name}, ${field.type})</small>
            </label>
          </div>
        `).join('');
      
      // Generate form fields config
      pbFormConfig.innerHTML = pbCurrentSchema.fields.map(field => {
        const isRelation = field.type === 'relation';
        const isSelect = field.type === 'select';
        const specialNote = isRelation ? '<br><small style="color:#2e7d32;">‚Üí Will load options from ' + (field.relationCollection || 'related collection') + '</small>' : 
                          isSelect ? '<br><small style="color:#f57c00;">‚Üí Static options from PocketBase</small>' : '';
        
        return `
          <div class="field-checkbox">
            <label>
              <input type="checkbox" 
                     data-field="${field.name}" 
                     data-type="${field.type}"
                     ${!['created', 'updated', 'id'].includes(field.name) ? 'checked' : ''}>
              ${field.label}
              <small>(${field.name}, ${field.type})</small>
              ${specialNote}
            </label>
          </div>
        `;
      }).join('');
    }
    
    // PB Generate button
    pbGenerateBtn.addEventListener('click', () => {
      if (!pbCurrentSchema) {
        pbShowError('Please load a schema first');
        return;
      }
      
      // Collect table columns
      const tableColumns = Array.from(document.querySelectorAll('#pb-table-columns-config input:checked'))
        .map(input => {
          const fieldName = input.dataset.field;
          const field = pbCurrentSchema.fields.find(f => f.name === fieldName);
          
          let format = null;
          if (field.type === 'date') {
            format = "val => val ? val.split('T')[0] : ''";
          } else if (field.type === 'bool') {
            format = "val => val ? 'S√≠' : 'No'";
          }
          
          return {
            key: field.name,
            label: field.label,
            format: format
          };
        });
      
      // Collect form fields
      const formFields = Array.from(document.querySelectorAll('#pb-form-fields-config input:checked'))
        .map(input => {
          const fieldName = input.dataset.field;
          const field = pbCurrentSchema.fields.find(f => f.name === fieldName);
          
          const fieldConfig = {
            name: field.name,
            label: field.label,
            type: field.inputType || field.type,
            required: field.required
          };
          
          // Handle different field types
          if (field.type === 'select' && field.options && field.options.length > 0) {
            fieldConfig.options = field.options.map(opt => ({
              value: opt,
              label: pbGenerator.formatLabel(opt)
            }));
          }
          
          if (field.type === 'relation') {
            fieldConfig.componentType = 'relation';
            fieldConfig.relationCollection = field.relationCollection;
          }
          
          if (field.type === 'number') {
            fieldConfig.step = '0.01';
          }
          
          if (field.type === 'json') {
            fieldConfig.placeholder = 'Ej: ["tag1", "tag2"]';
          }
          
          return fieldConfig;
        });
      
      // Generate module
      const config = {
        schema: pbCurrentSchema,
        tableColumns,
        formFields,
        moduleName: document.getElementById('pb-module-name').value,
        moduleLabel: document.getElementById('pb-module-label').value,
        icon: document.getElementById('pb-module-icon').value
      };
      
      try {
        pbGeneratedCode = pbGenerator.generateModule(config);
        pbGeneratedCodeEl.textContent = pbGeneratedCode;
        
        pbDownloadBtn.disabled = false;
        pbShowStatus(`‚úÖ Module "${config.moduleName}" generated successfully!`, 'success');
        
        // Auto-scroll to preview
        pbGeneratedCodeEl.scrollIntoView({ behavior: 'smooth' });
        
      } catch (error) {
        console.error('Generation error:', error);
        pbShowError('Failed to generate module: ' + error.message);
      }
    });
    
    // PB Download button
    pbDownloadBtn.addEventListener('click', () => {
      if (!pbGeneratedCode) {
        pbShowError('Generate code first');
        return;
      }
      
      const moduleName = document.getElementById('pb-module-name').value;
      
      try {
        const blob = new Blob([pbGeneratedCode], { type: 'text/javascript' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${moduleName}.js`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        pbShowStatus(`üì• Module downloaded as "${moduleName}.js"`, 'success');
      } catch (error) {
        pbShowError('Download failed: ' + error.message);
      }
    });
    
    // PB Helper functions
    function pbShowStatus(message, type = 'info') {
      pbGeneratorStatus.innerHTML = `
        <div class="${type === 'error' ? 'error-message' : type === 'success' ? 'success-message' : ''}">
          ${message}
        </div>
      `;
    }
    
    function pbShowError(message) {
      pbParsingError.textContent = message;
      pbParsingError.style.display = 'block';
      pbParsingSuccess.style.display = 'none';
    }
    
    function pbShowSuccess(message) {
      pbParsingSuccess.textContent = message;
      pbParsingSuccess.style.display = 'block';
      pbParsingError.style.display = 'none';
    }
    
    // ========== OpenAPI Generator ==========
    const openapiGenerator = new OpenAPIModuleGenerator();
    let openapiSpec = null;
    let openapiSchema = null;
    let openapiGeneratedCode = null;
    
    // DOM Elements for OpenAPI
    const openapiSpecEl = document.getElementById('openapi-spec');
    const loadOpenapiBtn = document.getElementById('load-openapi');
    const openapiCollectionEl = document.getElementById('openapi-collection');
    const openapiBuilder = document.getElementById('openapi-builder');
    const openapiPreview = document.getElementById('openapi-preview');
    const openapiSchemaInfo = document.getElementById('openapi-schema-info');
    const openapiFieldList = document.getElementById('openapi-field-list');
    const openapiRelationsInfo = document.getElementById('openapi-relations-info');
    const openapiGenerateBtn = document.getElementById('openapi-generate-code');
    const openapiDownloadBtn = document.getElementById('openapi-download-module');
    const openapiGeneratedCodeEl = document.getElementById('openapi-generated-code');
    const openapiGeneratorStatus = document.getElementById('openapi-generator-status');
    const openapiParsingError = document.getElementById('openapi-parsing-error');
    const openapiParsingSuccess = document.getElementById('openapi-parsing-success');
    
    // Load OpenAPI spec
    loadOpenapiBtn.addEventListener('click', () => {
      try {
        openapiParsingError.style.display = 'none';
        openapiParsingSuccess.style.display = 'none';
        
        openapiSpec = JSON.parse(openapiSpecEl.value);
        
        // Get all available collections from OpenAPI
        const schemas = openapiSpec.components.schemas;
        const collections = Object.keys(schemas)
          .filter(name => name.endsWith('Record'))
          .map(name => name.replace('Record', ''))
          .filter(name => !name.startsWith('_')); // Skip system collections
        
        // Populate collection dropdown
        openapiCollectionEl.innerHTML = '<option value="">-- Select a collection --</option>' +
          collections.map(col => `<option value="${col}">${col}</option>`).join('');
        
        openapiParsingSuccess.textContent = `‚úÖ Successfully parsed OpenAPI spec with ${collections.length} collections`;
        openapiParsingSuccess.style.display = 'block';
        
        openapiShowStatus(`Select a collection to generate module`, 'info');
        
      } catch (error) {
        console.error('Error parsing OpenAPI:', error);
        openapiShowError('Failed to parse OpenAPI spec: ' + error.message);
      }
    });
    
    // Collection selection
    openapiCollectionEl.addEventListener('change', () => {
      const collectionName = openapiCollectionEl.value;
      if (!collectionName) {
        openapiBuilder.style.display = 'none';
        openapiPreview.style.display = 'none';
        return;
      }
      
      try {
        openapiSchema = openapiGenerator.parseOpenAPISpec(openapiSpec, collectionName);
        
        // Auto-populate module name and label
        document.getElementById('openapi-module-name').value = collectionName;
        document.getElementById('openapi-module-label').value = openapiGenerator.formatLabel(collectionName);
        
        // Show schema info
        openapiRenderSchemaInfo();
        
        // Show builder and preview
        openapiBuilder.style.display = 'grid';
        openapiPreview.style.display = 'block';
        
        openapiShowStatus(`Ready to generate "${collectionName}" module`, 'info');
        
      } catch (error) {
        console.error('Error parsing collection:', error);
        openapiShowError('Failed to parse collection: ' + error.message);
      }
    });
    
    function openapiRenderSchemaInfo() {
      if (!openapiSchema) return;
      
      const relationCount = openapiSchema.relationFields.length;
      
      openapiSchemaInfo.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
          <div>
            <strong>Collection:</strong><br>
            <span style="font-size: 18px; color: #1976d2;">${openapiSchema.collectionName}</span>
          </div>
          <div>
            <strong>Type:</strong><br>
            ${openapiSchema.isChurchSpecific ? 'üèõÔ∏è Church-specific' : 'üåç Global'}
          </div>
          <div>
            <strong>Fields:</strong><br>
            ${openapiSchema.fields.length} total
          </div>
          <div>
            <strong>Relations:</strong><br>
            ${relationCount} detected
          </div>
        </div>
      `;
      
      // Render field list
      openapiFieldList.innerHTML = openapiSchema.fields.map(field => {
        const badgeClass = field.isRelation ? 'relation' : field.type === 'select' ? 'select' : '';
        const badgeText = field.isRelation ? 'Relation ‚Üí ' + (field.relationTo || 'unknown') : 
                         field.type === 'select' ? 'Select' : field.type;
        
        return `
          <div class="field-item">
            <div>
              <strong>${field.label}</strong><br>
              <small>${field.name} ‚Ä¢ ${field.required ? 'Required' : 'Optional'}</small>
            </div>
            <span class="field-badge ${badgeClass}">${badgeText}</span>
          </div>
        `;
      }).join('');
      
      // Render relations info
      if (openapiSchema.relationFields.length > 0) {
        openapiRelationsInfo.innerHTML = `
          <div style="background: #e8f5e8; padding: 10px; border-radius: 5px;">
            <h5>Detected Relations:</h5>
            <ul>
              ${openapiSchema.relationFields.map(rel => `
                <li><strong>${rel.label}</strong> ‚Üí ${rel.relationTo}</li>
              `).join('')}
            </ul>
            <small>These relations will automatically load data from their respective collections</small>
          </div>
        `;
      } else {
        openapiRelationsInfo.innerHTML = '<p>No relations detected in this collection.</p>';
      }
    }
    
    // OpenAPI Generate button
    openapiGenerateBtn.addEventListener('click', () => {
      if (!openapiSchema) {
        openapiShowError('Please select a collection first');
        return;
      }
      
      const config = {
        schema: openapiSchema,
        openapiSpec: openapiSpec,
        moduleName: document.getElementById('openapi-module-name').value,
        moduleLabel: document.getElementById('openapi-module-label').value,
        icon: document.getElementById('openapi-icon').value || 'üìã'
      };
      
      try {
        openapiGeneratedCode = openapiGenerator.generateModule(config);
        openapiGeneratedCodeEl.textContent = openapiGeneratedCode;
        
        openapiDownloadBtn.disabled = false;
        openapiShowStatus(`‚úÖ Module "${config.moduleName}" generated successfully!`, 'success');
        
        // Auto-scroll to preview
        openapiGeneratedCodeEl.scrollIntoView({ behavior: 'smooth' });
        
      } catch (error) {
        console.error('Generation error:', error);
        openapiShowError('Failed to generate module: ' + error.message);
      }
    });
    
    // OpenAPI Download button
    openapiDownloadBtn.addEventListener('click', () => {
      if (!openapiGeneratedCode) {
        openapiShowError('Generate code first');
        return;
      }
      
      const moduleName = document.getElementById('openapi-module-name').value;
      
      try {
        const blob = new Blob([openapiGeneratedCode], { type: 'text/javascript' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${moduleName}.js`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        openapiShowStatus(`üì• Module downloaded as "${moduleName}.js"`, 'success');
      } catch (error) {
        openapiShowError('Download failed: ' + error.message);
      }
    });
    
    // OpenAPI Helper functions
    function openapiShowStatus(message, type = 'info') {
      openapiGeneratorStatus.innerHTML = `
        <div class="${type === 'error' ? 'error-message' : type === 'success' ? 'success-message' : ''}">
          ${message}
        </div>
      `;
    }
    
    function openapiShowError(message) {
      openapiParsingError.textContent = message;
      openapiParsingError.style.display = 'block';
      openapiParsingSuccess.style.display = 'none';
    }
    
    function openapiShowSuccess(message) {
      openapiParsingSuccess.textContent = message;
      openapiParsingSuccess.style.display = 'block';
      openapiParsingError.style.display = 'none';
    }
    
    // Initialize with sample OpenAPI spec
    openapiSpecEl.value = JSON.stringify({
      openapi: "3.0.3",
      info: { title: "Sample", version: "1.0.0" },
      components: {
        schemas: {
          membersRecord: {
            type: "object",
            properties: {
              id: { type: "string" },
              first_name: { type: "string" },
              last_name: { type: "string" },
              church: { type: "string", description: "Relation field" }
            }
          }
        }
      }
    }, null, 2);
  </script>
</body>
</html>