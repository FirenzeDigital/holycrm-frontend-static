// assets/js/core/EnhancedModuleGenerator.js (Updated)
class EnhancedModuleGenerator {
    static async generateModuleFromConfig(config) {
        // This generates a complete module based on the config
        const moduleClass = `
class ${config.moduleKey.charAt(0).toUpperCase() + config.moduleKey.slice(1)}Module {
    constructor() {
        this.moduleKey = "${config.moduleKey}";
        this.name = "${config.moduleName}";
        this.icon = "${config.icon}";
        this.type = "${config.type}";
        this.collectionId = "${config.collectionId}";
        this.permissions = ${JSON.stringify(config.permissions)};
        
        // Initialize components
        this.table = null;
        this.form = null;
    }
    
    async initialize() {
        // Register with ModuleRegistry
        if (window.ModuleRegistry) {
            window.ModuleRegistry.registerModule(this);
        }
        
        // Initialize DataService
        this.dataService = window.DataService || null;
        
        return this;
    }
    
    renderList(container) {
        // Create EnhancedCrudTable
        this.table = new EnhancedCrudTable({
            module: this,
            container: container,
            columns: ${JSON.stringify(config.listView.columns)},
            itemsPerPage: ${config.listView.itemsPerPage},
            defaultSort: "${config.listView.defaultSort}"
        });
        
        this.table.render();
        this.loadData();
    }
    
    async loadData(page = 1) {
        if (!this.dataService) return;
        
        try {
            const data = await this.dataService.fetch({
                module: this.moduleKey,
                page: page,
                perPage: ${config.listView.itemsPerPage}
            });
            
            if (this.table) {
                this.table.updateData(data.items, data.totalPages, data.page);
            }
        } catch (error) {
            console.error('Error loading data:', error);
        }
    }
    
    openCreateForm() {
        this.openForm();
    }
    
    openEditForm(record) {
        this.openForm(record);
    }
    
    openForm(record = null) {
        this.form = new SmartModalForm({
            module: this,
            fields: ${JSON.stringify(config.formView.fields)},
            layout: "${config.formView.layout}",
            record: record,
            onSubmit: async (data) => {
                if (record) {
                    await this.updateRecord(record.id, data);
                } else {
                    await this.createRecord(data);
                }
                
                this.loadData(this.table?.currentPage || 1);
                this.form.close();
            }
        });
        
        this.form.open();
    }
    
    async createRecord(data) {
        if (!this.dataService) return;
        
        try {
            await this.dataService.create({
                module: this.moduleKey,
                data: data
            });
            
            return true;
        } catch (error) {
            console.error('Error creating record:', error);
            throw error;
        }
    }
    
    async updateRecord(id, data) {
        if (!this.dataService) return;
        
        try {
            await this.dataService.update({
                module: this.moduleKey,
                id: id,
                data: data
            });
            
            return true;
        } catch (error) {
            console.error('Error updating record:', error);
            throw error;
        }
    }
    
    async deleteRecord(id) {
        if (!this.dataService) return;
        
        try {
            await this.dataService.delete({
                module: this.moduleKey,
                id: id
            });
            
            return true;
        } catch (error) {
            console.error('Error deleting record:', error);
            throw error;
        }
    }
    
    checkPermission(action) {
        const userRole = this.getCurrentRole();
        if (!userRole) return false;
        
        return this.permissions[userRole]?.[action] || false;
    }
    
    getCurrentRole() {
        // Get from your auth system
        return window.currentUser?.role || 'guest';
    }
}

// Export
if (typeof window !== 'undefined') {
    window.${config.moduleKey.charAt(0).toUpperCase() + config.moduleKey.slice(1)}Module = ${config.moduleKey.charAt(0).toUpperCase() + config.moduleKey.slice(1)}Module;
}
`;
        
        return moduleClass;
    }
    
    static generateModuleFile(config) {
        const header = `// Generated module: ${config.moduleName}
// Collection: ${config.collectionId}
// Generated: ${new Date().toISOString()}
// DO NOT EDIT THIS FILE DIRECTLY
`;

        const moduleCode = this.generateModuleFromConfig(config);
        return header + moduleCode;
    }
}